{% extends "../../partials/layout.njk" %}
{% from "../../partials/navBar.njk" import navBar with context %}
{% from "../../partials/breadCrumb.njk" import breadCrumb %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/checkboxes/macro.njk" import govukCheckboxes %}
{% from "govuk/components/error-summary/macro.njk" import govukErrorSummary %}
{% from "govuk/components/radios/macro.njk" import govukRadios %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "moj/components/pagination/macro.njk" import mojPagination %}
{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}
{#{% from "./partials/prisonerSearch.njk" import prisonerSearch %}#}

{% set offendersToBeReleased = prisonerSearchResults.content %}
{% set title = 'Get someone ready for work' %}

{#
Data supplied to this template:

  *
#}

{% block beforeContent %}
    {% set breadCrumbList = [ {href: '/work-Profile', title: title } ] %}
    {{ breadCrumb('Work readiness', breadCrumbList) }}
{% endblock %}

{% block content %}

    <h1 class="govuk-heading-l govuk-!-margin-bottom-7">{{ title }}</h1>
       <form novalidate="novalidate" class="prisoner-search__form" data-test="prisoner-search-form">
        <div class="horizontal-form govuk-!-margin-bottom-3">

            <div action="" method="post">
                <input type="hidden" name="_csrf" value="{{ csrfToken }}" />

                <div class="govuk-grid-row govuk-!-display-none-print">
                    {# This whole section has a grey background colour #}
                    <div class="govuk-grid-column-full">
                        <div class="govuk-!-padding-left-3 govuk-!-padding-right-3 filter-box-color">
                            <div class="govuk-grid-column-full govuk-!-margin-bottom-3">
                                {{ govukRadios({
                                    classes: "govuk-radios--inline govuk-radios--small",
                                    idPrefix: "status",
                                    name: "selectStatus",
                                    fieldset: {
                                        attributes: { 'data-test': 'status-input' },
                                        legend: {
                                            text: 'Status',
                                            classes: "govuk-fieldset__legend--s govuk-!-margin-bottom-0"
                                        }
                                    },
                                    items: [
                                        {
                                            id: 'allStatusFilter',
                                            value: 'all',
                                            text: 'all',
                                            checked: 'true'
                                        },
                                        {
                                            id: 'notStartedStatusFilter',
                                            value: 'noStarted',
                                            text: 'No started'
                                        },
                                        {
                                            id: 'needsSupportStatusFilter',
                                            value: 'needsSupport',
                                            text: 'Needs support'
                                        },
                                        {
                                            id: 'readyToWorkStatusFilter',
                                            value: 'readyToWork',
                                            text: 'Ready to work'
                                        },
                                        {
                                            id: 'doesNotWantSupportStatusFilter',
                                            value: 'doesNotWantSupport',
                                            text: 'Does not want to support'
                                        },
                                        {
                                            id: 'noRightToWorkStatusFilter',
                                            value: 'noRightToWork',
                                            text: 'No right to work'
                                        }
                                    ]
                                }) }}

                                {{ govukInput({
                                    classes: 'govuk-input--width-20',
                                    id: 'filterByName',
                                    name: 'filterByName',
                                    errorMessage: errors | findError('filterByName'),
                                    label: {
                                        text: 'Search by prisoner name',
                                        classes: 'govuk-label--s',
                                        isPageHeading: true
                                    }
                                }) }}
                                {{ govukButton({ text: 'Search',
                                    type: 'Apply',
                                    classes: 'govuk-!-margin-bottom-0 filter-panel-apply-button',
                                    attributes: {'data-qa': 'filter-panel-apply-button'},
                                    preventDoubleClick: true
                                }) }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
       </form>

    <hr class="govuk-section-break govuk-section-break--l govuk-section-break--visible">
    {{ mojPagination( paginationData ) }}
    {{ offenderList(offendersToBeReleased) }}
    {{ mojPagination( paginationData ) }}

{% endblock %}

{# ------------------------------------------------------------- #}
{# Present list of offenders table pre-filtered based on choices #}
{# ------------------------------------------------------------- #}

{% macro offenderList(offenders) %}
    <div id="offender-container">
        <table id="view-offender" class="govuk-table view-offender">
            <thead class="govuk-table__head">
            <tr class="govuk-table__row">
                <th scope="col" class="govuk-table__header aria-sort='ascending'">Prisoner</th>
                <th scope="col" class="govuk-table__header aria-sort='none'">Release type and date</th>
                <th scope="col" class="govuk-table__header sortable">Status</th>
                <th scope="col" class="govuk-table__header">Work summary</th>
                <th scope="col" class="govuk-table__header sortable">Updated on</th>
            </tr>
            </thead>

            <tbody class="govuk-table__body">
            {% set rowClass = cycler("odd", "even") %}

            {% for offender in offenders %}

                <tr class="govuk-table__row {{ rowClass.next() }}">
                    {% set quickLookUrl = dpsUrl + '/offenders/' + offender.prisonerNumber + '/quick-look' %}
                    <td class="govuk-table__cell">
                        <a href="{{ quickLookUrl }}"
                           target="_blank"
                           rel="noopener noreferrer"
                           data-qa="quick-look-link"
                           class="govuk-link govuk-link--no-visited-state govuk-!-font-weight-bold">{{ offender.displayName }}</a>
                    </br><span class="govuk-hint govuk-!-margin-bottom-0">{{ offender.prisonerNumber }}</span>
                    </td>
                    <td class="govuk-table__cell">{{ offender.nonDtoReleaseDateType or '' }}
                        <p>{{ offender.releaseDate or 'N/A' }}</p>
                    </td>
                    <td class="govuk-table__cell"> {{ statusTag(offender.status) }}</td>
                    {% if offender.status == 'SUPPORT_NEEDED' %}
                        {{ supportNeeded(offender) }}
                    {% elseif offender.status == 'READY_TO_WORK' %}
                        {{ readyToWork(offender) }}
                    {% elseif offender.status == 'SUPPORT_DECLINED' %}
                        {{ supportDeclined(offender) }}
                    {% elseif offender.status == 'NO_RIGHT_TO_WORK' %}
                        <td {{ noRightToWork(offender) }}</td>
                    {% elseif offender.status == 'NOT_STARTED' %}
                        <td {{ notStarted(offender) }}</td>
                    {% else %}
                        <td class="govuk-table__cell"></td>
                    {% endif %}
                    <td class="govuk-table__cell">{{ offender.updatedOn or 'N/A' }}</td>
                </tr>

            {% endfor %}

            </tbody>

        </table>
    </div>
{% endmacro %}

{# Tab macro to display the correct colour for a given status, defaults to grey #}
{% macro statusTag(status) %}
    {%
        set statusColourLookup = {
        'NOT_STARTED': 'red',
        'SUPPORT_NEEDED': 'yellow',
        'READY_TO_WORK': 'green',
        'COMPLETED': 'green',
        'IN_PROGRESS': 'yellow'
    }
    %}
    {%
        set statusLookup = {
        'NOT_STARTED': 'NOT STARTED',
        'SUPPORT_NEEDED': 'SUPPORT NEEDED',
        'READY_TO_WORK': 'READY TO WORK',
        'COMPLETED': 'COMPLETED',
        'NO_RIGHT_TO_WORK': 'NO RIGHT TO WORK',
        'SUPPORT_DECLINED': 'SUPPORT DECLINED',
        'IN_PROGRESS': 'IN PROGRESS'
        }
    %}
    {%
        set colour = statusColourLookup[status]
    %}
    <strong class="govuk-tag govuk-tag--{{ colour if colour else 'grey' }}">{{ statusLookup[status] }}</strong>
{% endmacro %}

{% macro supportNeeded(offender) %}
    {% set summary = offender.supportNeeded %}
    <td class="govuk-table__cell">
    <p class="govuk-body govuk-!-margin-bottom-1">Needs help with:</p>
    <ul class="govuk-list govuk-list--bullet">
    {% for item in summary %}
        <li>
            <span class="govuk-!-font-weight-regular">{{ item | capitalize }}</span>
        </li>
    {% endfor %}
    </ul>
    </td>
{% endmacro %}

{% macro readyToWork(offender) %}
    {% set summary = offender.workTypeInterests %}
    <td class="govuk-table__cell">
    <p class="govuk-body govuk-!-margin-bottom-1">Looking for work in:</p>
    <ul class="govuk-list govuk-list--bullet">
    {% for item in summary %}
        <li>
            <span class="govuk-!-font-weight-regular">{{ item | capitalize }}</span>
        </li>
    {% endfor %}
    </ul>
    </td>
{% endmacro %}

{% macro supportDeclined(offender) %}
    {% set summary = offender.supportDeclinedReasons %}
    <td class="govuk-table__cell">
    <p class="govuk-body govuk-!-margin-bottom-1">Reason:</p>
    <ul class="govuk-list govuk-list--bullet">
    {% for item in summary %}
        <li>
            <span class="govuk-!-font-weight-regular">{{ item | capitalize }}</span>
        </li>
    {% endfor %}
    </ul>
    </td>
{% endmacro %}

{% macro noRightToWork(offender) %}
    {% set value = offender.noRightToWork %}
    class="govuk-table__cell">{{ value if value else 'N/A' }}
{% endmacro %}

{% macro notStarted(offender) %}
    {% set value = offender.notStarted %}
    class="govuk-table__cell">{{ value if value else 'N/A' }}
{% endmacro %}